<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>LÖVE Cookbook | Compute Shaders</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Compute Shaders</title>
<meta name="title" content="Compute Shaders">
<meta name="author" content="Jasper">
<meta name="description" content="Compute shaders are a more general way to do calculations with GLSL, as opposed to the vertex and fragment shader, which are a lot more constrained.">
<meta name="generator" content="eleventy">
<meta property="og:type" content="website">
<meta property="og:url" content="https://diminim.github.io/love-cookbook/guides/intermediate/compute-shaders/">
<meta property="og:locale" content="en_US">
<meta property="og:title" content="Compute Shaders">
<meta property="og:description" content="Compute shaders are a more general way to do calculations with GLSL, as opposed to the vertex and fragment shader, which are a lot more constrained.">
<meta property="og:image" content="https://diminim.github.io/love-cookbook/assets/logo.png">
<meta property="og:image:alt" content="LÖVE Cookbook">
<meta name="twitter:card" content="summary">
<meta name="twitter:url" content="https://diminim.github.io/love-cookbook/guides/intermediate/compute-shaders/">
<meta name="twitter:title" content="Compute Shaders">
<meta name="twitter:description" content="Compute shaders are a more general way to do calculations with GLSL, as opposed to the vertex and fragment shader, which are a lot more constrained.">
<meta name="twitter:image" content="https://diminim.github.io/love-cookbook/assets/logo.png">
<meta name="twitter:image:alt" content="LÖVE Cookbook">
<link rel="canonical" href="https://diminim.github.io/love-cookbook/guides/intermediate/compute-shaders/">

    <script src="/love-cookbook/assets/js/codeblock.js"></script>
    <script src="/love-cookbook/assets/js/hover_preview.js"></script>
    <script src="/love-cookbook/assets/js/mobile.js"></script>

    <link rel="stylesheet" href="/love-cookbook/assets/styles/fonts.css">
    <link rel="stylesheet" href="/love-cookbook/assets/styles/main.css">
    <link rel="stylesheet" href="/love-cookbook/assets/styles/prism.css">
    <link rel="stylesheet" href="/love-cookbook/assets/styles/markdown.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mali:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=menu" rel="stylesheet">
  </head>
  <body>
    <div class="sidebar">
      <header>
        <a href="/love-cookbook/">
            <div class="logo">
                <img class="logo-unhover-img" src="/love-cookbook/assets/logo.png">
                <img class="logo-hover-img" src="/love-cookbook/assets/logo_hover.png">
            </div>

            <h1>LÖVE Cookbook</h1>
        </a>
      </header>

      <nav class="table-of-contents">
        <ul class="chapters"><li class="group-header"><ul class="guides"><li><a class="" href="/love-cookbook/guides/getting-started/">Getting started</a>
                  </li><li><a class="" href="/love-cookbook/guides/fiddle/">Fiddle</a>
                  </li></ul>

            </li><li class="group-header">Installation<ul class="guides"><li><a class="" href="/love-cookbook/guides/installation/love/">LÖVE</a>
                  </li><li><a class="" href="/love-cookbook/guides/installation/vscode/">VSCode</a>
                  </li><li><a class="" href="/love-cookbook/guides/installation/neovim/">Neovim</a>
                  </li></ul>

            </li><li class="group-header">Lua Basics<ul class="guides"><li><a class="" href="/love-cookbook/guides/lua-basics/lua/">Lua</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-basics/variables/">Variables</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-basics/functions/">Functions</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-basics/if-statements/">If-statements</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-basics/tables/">Tables and for-loops</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-basics/gotchas/">Gotchas</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-basics/recap/">Recap</a>
                  </li></ul>

            </li><li class="group-header">Lua Intermediate<ul class="guides"><li><a class="" href="/love-cookbook/guides/lua-intermediate/require/">Require</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-intermediate/scope/">Scope</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-intermediate/modulo/">Modulo</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-intermediate/nested-for-loops/">Nested for-loops</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-intermediate/standard-library/">Standard library</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-intermediate/string-patterns/">String patterns</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-intermediate/ternary-operators/">Ternary operators</a>
                  </li><li><a class="" href="/love-cookbook/guides/lua-intermediate/metatables/">Metatables</a>
                  </li></ul>

            </li><li class="group-header">LÖVE Basics<ul class="guides"><li><a class="" href="/love-cookbook/guides/love/drawing-image/">Drawing an image</a>
                  </li><li><a class="" href="/love-cookbook/guides/love/drawing-shapes/">Drawing shapes</a>
                  </li><li><a class="" href="/love-cookbook/guides/love/playing-audio/">Playing audio</a>
                  </li><li><a class="" href="/love-cookbook/guides/love/input/">Input</a>
                  </li><li><a class="" href="/love-cookbook/guides/love/filesystem/">Filesystem</a>
                  </li><li><a class="" href="/love-cookbook/guides/love/deltatime/">Deltatime</a>
                  </li><li><a class="" href="/love-cookbook/guides/love/reading-errors/">Reading errors</a>
                  </li></ul>

            </li><li class="group-header">Basics<ul class="guides"><li><a class="" href="/love-cookbook/guides/basic/aabb/">AABB</a>
                  </li><li><a class="" href="/love-cookbook/guides/basic/angle-and-distance/">Angle &amp; distance</a>
                  </li><li><a class="" href="/love-cookbook/guides/basic/tiles/">Tiles</a>
                  </li><li><a class="" href="/love-cookbook/guides/basic/animation/">Animation</a>
                  </li><li><a class="" href="/love-cookbook/guides/basic/saving-and-loading/">Saving &amp; loading</a>
                  </li><li><a class="" href="/love-cookbook/guides/basic/canvases/">Canvases</a>
                  </li><li><a class="" href="/love-cookbook/guides/basic/stencil-modes/">Stencil modes</a>
                  </li></ul>

            </li><li class="group-header">Intermediate<ul class="guides"><li><a class="" href="/love-cookbook/guides/intermediate/oop/">OOP</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/collision-resolving/">Collision resolution</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/stencil-states/">Stencil states</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/coroutines/">Coroutines</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/shaders/">Shaders</a>
                  </li><li><a class="active" href="/love-cookbook/guides/intermediate/compute-shaders/">Compute Shaders</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/box-blur/">Box Blur</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/outlines/">Outlines</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/palette/">Palette</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/pixelation/">Pixelation</a>
                  </li><li><a class="" href="/love-cookbook/guides/intermediate/vertex-shaders/">Vertex Shaders</a>
                  </li></ul>

            </li><li class="group-header">Advanced<ul class="guides"><li><a class="" href="/love-cookbook/guides/advanced/physics/">Physics</a>
                  </li><li><a class="" href="/love-cookbook/guides/advanced/threads/">Threads</a>
                  </li></ul>

            </li><li class="group-header">Recipes<ul class="guides"><li><a class="" href="/love-cookbook/guides/recipes/screen-resizing/">Screen resizing</a>
                  </li><li><a class="" href="/love-cookbook/guides/recipes/steam/">Steam</a>
                  </li></ul>

            </li></ul>

      </nav>
    </div>

    <main>
      <article class="guide">
        
<header class="guide-header">
  <button type="button" class="menu-button">
    <i class="material-symbols-outlined">menu</i>
  </button>

  <h1 class="title">Compute Shaders</h1>
</header>

<p><strong>Compute shaders</strong> are a more general way to do calculations with GLSL, as opposed to the vertex and fragment shader, which are a lot more constrained.</p>
<div class="markdown-alert markdown-alert-caution"><p class="markdown-alert-title"><svg class="octicon octicon-stop mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p><p>This guide is made for LÖVE 12.0!</p>
</div>
<p>To edit data outside of the shader, we can use <strong>SSBO's</strong> (Shader storage buffer object) and textures.
Textures need to be marked as computewritable with the <code>computewrite</code> tag, but we'll get to that.</p>
<p><strong>SSBO's</strong> are a way to store a large amount of data.
A compute shader can perform <code>read</code> and <code>write</code> operations on these <code>buffers</code>.</p>
<p>One of the things we're going to encounter sometimes when writing compute shaders is issues with memory read and write operations.
This is because we don't have complete control over when threads are accessing data.</p>
<h2 id="buffer-types" tabindex="-1">Buffer types <a class="anchor" href="#buffer-types">#</a></h2>
<p>Let's go over some of the different types of <code>buffers</code>, these can be combined if need be.</p>
<ul>
<li>
<p><code>shaderstorage</code>, allows the buffer to be read and written to and from in a shader
(we can read in fragment, vertex and compute shaders, but only write in compute shaders). One thing to keep in mind is memory alignment of 4 bytes.</p>
</li>
<li>
<p><code>vertex</code>, allows the buffer to be used as inputs to a vertex shader, this is what is used when creating a new mesh. Memory alignment isn't as strict allowing for more compact data storage,
If we combine this with <code>shaderstorage</code>, the memory alignment will be forced to 4 bytes again, which is something that needs to be accounted for</p>
</li>
<li>
<p><code>index</code>, allows the buffer to be used as an index buffer for a vertex shader, which is used to store indices we send with the <code>setVertexMap</code> method of meshes.
the format can only be <code>uint16</code> and <code>uint32</code>.</p>
</li>
<li>
<p><code>indirectarguments</code>, allows the buffer to be used parameters for a draw command, effectively allowing the gpu to generate it's own work without needing readbacks.</p>
</li>
</ul>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>When defining `buffers` in GLSL, LÖVE automatically adds the std430 qualifier, which allows for better packing of data. So we don't have to add that.</p><p></p>
</div>
<h2 id="thread-groups" tabindex="-1">Thread groups <a class="anchor" href="#thread-groups">#</a></h2>
<p>Compute shaders are executed in three dimensional thread groups, each group has N amount of <a href="../shaders#thread" data-preview="../shaders#thread">threads</a>, which we can define using <code>local_size_n = m</code> in the compute shader later.
Defining the local size to amount to 64 <a href="../shaders#thread" data-preview="../shaders#thread">threads</a> per thread group is usually optimal, <a href="../shaders#thread" data-preview="../shaders#thread">threads</a> within a thread group can communicate with eachother using <code>shared</code> variables.
They can also be synced with <a href="#barriers">barriers</a> meaning every <a href="../shaders#thread" data-preview="../shaders#thread">thread</a> has to be at the same point in execution to continue, though this should be done sparingly.</p>
<h3 id="built-in-variables" tabindex="-1">Built-in variables <a class="anchor" href="#built-in-variables">#</a></h3>
<p>The local position in the thread group is stored in the <code>gl_LocalInvocationID</code> <code>uvec3</code>,
The position of the entire group is stored in the <code>gl_WorkGroupID</code> <code>uvec3</code>,
And finally the global position (group pos + local pos in group) is stored in the <code>gl_GlobalInvocationID</code> <code>uvec3</code> input variable  .</p>
<h2 id="particles" tabindex="-1">Particles <a class="anchor" href="#particles">#</a></h2>
<p>let's start with a <s>small</s> compute shader for moving particles around on the screen.
We have two shader files,</p>
<p><code>updateParticles.glsl</code> Is the compute shader which edits the particle data stored in our SSBO, by moving them around.
<code>drawParticles.glsl</code> Is the <strong>vertex</strong> and <strong>fragment shader</strong> which draw the particles to the screen.</p>
<p>Finally, our <code>main.lua</code> file will tell GLSL how to update our particles and where they spawn initially.</p>
<p><code>updateParticles.glsl</code></p>
<pre><code class="language-glsl"><span data-attrs=""></span><span class="token comment">// A final local size amounting to 64 is optimal.</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>local_size_x <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> local_size_y <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> local_size_z <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">;</span>

<span class="token comment">// Let's define a struct for our particles</span>
<span class="token keyword">struct</span> <span class="token class-name">Particle</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> Position<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> Velocity<span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> Color<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The buffer will be called "Particles" when sending it from the CPU</span>
<span class="token keyword">restrict</span> <span class="token keyword">buffer</span> Particles <span class="token punctuation">{</span>
    <span class="token comment">// An array of the `Particle` struct with an unknown size.</span>
    Particle particles<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mediump</span> <span class="token keyword">float</span> DeltaTime<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mediump</span> <span class="token keyword">uint</span> ParticleCount<span class="token punctuation">;</span>

<span class="token comment">// Min-X, min-Y, max-X, max-Y</span>
<span class="token keyword">uniform</span> <span class="token keyword">mediump</span> <span class="token keyword">vec4</span> WorldSize<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">computemain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// get the ID of this thread, which we'll use as the index of the particle to simulate.</span>
    <span class="token keyword">uint</span> index <span class="token operator">=</span> gl_GlobalInvocationID<span class="token punctuation">.</span>x<span class="token punctuation">;</span>

    <span class="token comment">// Since this compute shader has a group size bigger than 1 (Which we should always use),</span>
    <span class="token comment">// The Particle count might not be evenly divisible by the group size,</span>
    <span class="token comment">// causing us to launch a few extra threads that won't be doing anything.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> ParticleCount<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Move the particle</span>
    particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Position <span class="token operator">+=</span> particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity <span class="token operator">*</span> DeltaTime<span class="token punctuation">;</span>

    <span class="token comment">// Let's make the particles bounce around the screen.</span>

    <span class="token keyword">vec2</span> Position <span class="token operator">=</span> particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Position<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> WorldSize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Position<span class="token punctuation">.</span>x <span class="token operator">></span> WorldSize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">abs</span><span class="token punctuation">(</span>particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Position<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> WorldSize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Position<span class="token punctuation">.</span>y <span class="token operator">></span> WorldSize<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">abs</span><span class="token punctuation">(</span>particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Velocity<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>drawParticles.glsl</code></p>
<pre><code class="language-glsl"><span data-attrs=""></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">language glsl4</span></span>
<span class="token comment">// Define our particles again</span>
<span class="token keyword">struct</span> <span class="token class-name">Particle</span> <span class="token punctuation">{</span>
    <span class="token keyword">vec2</span> Position<span class="token punctuation">;</span>
    <span class="token keyword">vec2</span> Velocity<span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> Color<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The restrict keyword allows the compiler to optimize the buffer access better.</span>
<span class="token comment">// Readonly means we won't be writing to the buffer. (Which we want anyways since that's faster)</span>
<span class="token comment">// But it will also cause an error if we don't use the buffer as readonly in the shader.</span>
<span class="token keyword">restrict</span> <span class="token keyword">readonly</span> <span class="token keyword">buffer</span> Particles <span class="token punctuation">{</span>
    Particle particles<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">VERTEX</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> vColor<span class="token punctuation">;</span>
<span class="token keyword">vec4</span> <span class="token function">position</span><span class="token punctuation">(</span><span class="token keyword">mat4</span> transform_projection<span class="token punctuation">,</span> <span class="token keyword">vec4</span> vertex_position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gl_PointSize <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">uint</span> index <span class="token operator">=</span> love_VertexID<span class="token punctuation">;</span>
    vColor <span class="token operator">=</span> particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Color<span class="token punctuation">;</span>

    <span class="token comment">// Ignore the input vertex position and use the particle position instead.</span>
    <span class="token keyword">return</span> transform_projection <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>particles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Position<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">PIXEL</span></span>
<span class="token keyword">in</span> <span class="token keyword">vec4</span> vColor<span class="token punctuation">;</span>
<span class="token keyword">vec4</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token keyword">vec4</span> color<span class="token punctuation">,</span> Image tex<span class="token punctuation">,</span> <span class="token keyword">vec2</span> texture_coords<span class="token punctuation">,</span> <span class="token keyword">vec2</span> screen_coords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> vColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
<pre><code class="language-lua"><span data-attrs=""></span><span class="token keyword">local</span> drawShader <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">newShader</span><span class="token punctuation">(</span><span class="token string">"drawParticles.glsl"</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> particleShader <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">newComputeShader</span><span class="token punctuation">(</span><span class="token string">"updateParticles.glsl"</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> particleFormat <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">-- name doesn't do anything but it's nicer to read</span>
    <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"Position"</span><span class="token punctuation">,</span> format <span class="token operator">=</span> <span class="token string">"floatvec2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"Velocity"</span><span class="token punctuation">,</span> format <span class="token operator">=</span> <span class="token string">"floatvec2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"Color"</span><span class="token punctuation">,</span>    format <span class="token operator">=</span> <span class="token string">"floatvec4"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">local</span> particleCount <span class="token operator">=</span> <span class="token number">1000000</span>
<span class="token keyword">local</span> buffer <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">newBuffer</span><span class="token punctuation">(</span>particleFormat<span class="token punctuation">,</span> particleCount<span class="token punctuation">,</span> <span class="token punctuation">{</span> shaderstorage <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> worldSize <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
particleShader<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"WorldSize"</span><span class="token punctuation">,</span> worldSize<span class="token punctuation">)</span>
particleShader<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"ParticleCount"</span><span class="token punctuation">,</span> particleCount<span class="token punctuation">)</span>
particleShader<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Particles"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>
drawShader<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Particles"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span>

<span class="token comment">-- FYI, If we want to update particles from the cpu every frame, or make it start faster,</span>
<span class="token comment">-- it's better to use ByteData.</span>

<span class="token keyword">local</span> particles <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">local</span> width<span class="token punctuation">,</span> height <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">getDimensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> particleCount <span class="token keyword">do</span>
    table<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>particles<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
        love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">randomNormal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">randomNormal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

buffer<span class="token punctuation">:</span><span class="token function">setArrayData</span><span class="token punctuation">(</span>particles<span class="token punctuation">)</span>

<span class="token comment">-- Create a mesh to run the vertex shader</span>
<span class="token keyword">local</span> format <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">'VertexPosition'</span><span class="token punctuation">,</span> location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> format <span class="token operator">=</span> <span class="token string">'float'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">local</span> mesh <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">newMesh</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> particleCount<span class="token punctuation">,</span> <span class="token string">'points'</span><span class="token punctuation">,</span>
    <span class="token string">'static'</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">updateParticles</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
    <span class="token comment">-- Update the delta time</span>
    particleShader<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"DeltaTime"</span><span class="token punctuation">,</span> dt<span class="token punctuation">)</span>

    <span class="token comment">-- Get the local thread group size and divide the amount of particles we have by that amount</span>
    <span class="token comment">-- Since every thread group will edit that amount of particles.</span>
    <span class="token keyword">local</span> sizeX<span class="token punctuation">,</span> sizeY<span class="token punctuation">,</span> sizeZ <span class="token operator">=</span> particleShader<span class="token punctuation">:</span><span class="token function">getLocalThreadgroupSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sizeX <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>particleCount <span class="token operator">/</span> sizeX<span class="token punctuation">)</span>

    <span class="token comment">-- Use this function to dispatch the compute shader</span>
    love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">dispatchThreadgroups</span><span class="token punctuation">(</span>particleShader<span class="token punctuation">,</span> sizeX<span class="token punctuation">,</span> sizeY<span class="token punctuation">,</span> sizeZ<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> love<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
    <span class="token function">updateParticles</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> love<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">setShader</span><span class="token punctuation">(</span>drawShader<span class="token punctuation">)</span>
    love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>mesh<span class="token punctuation">)</span>
    love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">setShader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Simulating "</span> <span class="token operator">..</span> particleCount <span class="token operator">..</span> <span class="token string">" Particles at "</span> <span class="token operator">..</span> love<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">getFPS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">..</span> <span class="token string">" FPS"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre>
<h2 id="average-of-pixels" tabindex="-1">Average of pixels <a class="anchor" href="#average-of-pixels">#</a></h2>
<div class="markdown-alert markdown-alert-important"><p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>`Image` and `image2D` are two different things, the first defining a 2D sampler (Readonly texture), the other a 2D image (Read / Write texture)</p><p></p>
</div>
<p>This compute shader will take any image with a size that is a multiple of 8, and calculate the average of those 64 pixels, then store it in another image.</p>
<h3 id="barriers" tabindex="-1">Barriers <a class="anchor" href="#barriers">#</a></h3>
<p>To make sure all threads have read their data before we start calculating the average, we use a <code>barrier</code>, this will make sure all threads are at the same point in execution before continuing.</p>
<p>Barriers only act between threads in the same thread group, meaning we can't sync all of the threads in the compute shader.
GLSL has these barrier functions available:</p>
<ul>
<li><code>barrier</code><br>
Halts execution until all threads in the thread group have reached this point.</li>
<li><code>memoryBarrier</code><br>
Ensures that all memory accesses before the barrier are visible to all threads in the thread group after the barrier.</li>
</ul>
<p>The following are variations of the <code>memoryBarrier</code> function, each only looking at a specific type of memory access:</p>
<ul>
<li>groupMemoryBarrier</li>
<li>memoryBarrierAtomicCounter</li>
<li>memoryBarrierBuffer</li>
<li>memoryBarrierImage</li>
<li>memoryBarrierShared</li>
</ul>
<pre><code class="language-glsl"><span data-attrs=""></span><span class="token comment">// 8*8*1 = 64 threads</span>
<span class="token keyword">layout</span><span class="token punctuation">(</span>local_size_x <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> local_size_y <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> local_size_z <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">;</span>

<span class="token comment">// Input Texture</span>
<span class="token keyword">uniform</span> Image InputImage<span class="token punctuation">;</span>

<span class="token keyword">layout</span><span class="token punctuation">(</span>rgba8<span class="token punctuation">)</span> <span class="token keyword">uniform</span> <span class="token keyword">mediump</span> <span class="token keyword">restrict</span> <span class="token keyword">writeonly</span> <span class="token keyword">image2D</span> OutputImage<span class="token punctuation">;</span>
<span class="token comment">// This line has way too many qualifiers :O</span>
<span class="token comment">// Let's break it down!</span>
<span class="token comment">// layout(rgba8), the type of an image needs to be defined beforehand, which we do like so. (rgba8 meaning the format of the image)</span>
<span class="token comment">// uniform, meaning this can be set from the CPU, which is necessary for images</span>
<span class="token comment">// mediump, meaning we want mediump precision (only really necessary for mobile)</span>
<span class="token comment">// restrict, allows the compiler to optimise read and write operations better</span>
<span class="token comment">// writeonly, tells the compiler we only want to write to this image</span>

<span class="token comment">// Our first shared variable, every thread within the thread group can read and write to this!</span>
<span class="token keyword">shared</span> <span class="token keyword">vec4</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> Colors<span class="token punctuation">;</span>
<span class="token keyword">shared</span> <span class="token keyword">vec4</span> Average<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">computemain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">ivec2</span> position <span class="token operator">=</span> <span class="token keyword">ivec2</span><span class="token punctuation">(</span>gl_GlobalInvocationID<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">ivec2</span> size <span class="token operator">=</span> <span class="token function">textureSize</span><span class="token punctuation">(</span>InputImage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>position<span class="token punctuation">.</span>x <span class="token operator">></span> size<span class="token punctuation">.</span>x <span class="token operator">||</span> position<span class="token punctuation">.</span>y <span class="token operator">></span> size<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Sample at the desired position and mip 0</span>
    <span class="token keyword">vec4</span> CurrentColor <span class="token operator">=</span> <span class="token function">texelFetch</span><span class="token punctuation">(</span>InputImage<span class="token punctuation">,</span> position<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Colors<span class="token punctuation">[</span>gl_LocalInvocationID<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>gl_LocalInvocationID<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> CurrentColor<span class="token punctuation">;</span>

    <span class="token comment">// Now, if we were to try to calculate the average now, some threads might still be waiting on their texture fetch</span>
    <span class="token comment">// and we'd be using random numbers (as variables aren't reset to a default when creating them)</span>

    <span class="token function">barrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Let's let the first thread compute the Average</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>gl_LocalInvocationID<span class="token punctuation">.</span>x <span class="token operator">==</span> <span class="token number">0u</span> <span class="token operator">&amp;&amp;</span> gl_LocalInvocationID<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token number">0u</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">vec4</span> sum <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
                sum <span class="token operator">+=</span> Colors<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>

        Average <span class="token operator">=</span> sum <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">64.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Wait for the first thread to compute the average</span>
    <span class="token function">barrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">imageStore</span><span class="token punctuation">(</span>OutputImage<span class="token punctuation">,</span> position<span class="token punctuation">,</span> Average<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="language-lua"><span data-attrs=""></span><span class="token keyword">local</span> shader <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">newComputeShader</span><span class="token punctuation">(</span><span class="token string">"AveragingShader.glsl"</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> img <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">newImage</span><span class="token punctuation">(</span><span class="token string">"YourImage.png"</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> blurred <span class="token operator">=</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">newTexture</span><span class="token punctuation">(</span>love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> computewrite <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

shader<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"InputImage"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
shader<span class="token punctuation">:</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"OutputImage"</span><span class="token punctuation">,</span> blurred<span class="token punctuation">)</span>

love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">dispatchThreadgroups</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> love<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    love<span class="token punctuation">.</span>graphics<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span>blurred<span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre>


<footer class="guide-footer">
  <p></p>

  <p>By:
  
      <em>Jasper</em>
    
  </p>
</footer>
      </article>
    </main>

  </body>
</html>